import type { LinksFunction, MetaFunction, ActionFunctionArgs } from "@remix-run/node";
import { json } from "@remix-run/node";
import { useLoaderData, Link } from "@remix-run/react";
import { useState, useEffect } from "react";
import { LazyMotion, domAnimation, m } from "framer-motion";
import { useImageToken } from "~/hooks/useImageToken.client";
import { ClientOnly } from "~/components/common/ClientOnly";

// Types for photo gallery data
interface ImageData {
  id: string | number;
  src: string;
  alt?: string; // ‰ΩøaltÂèØÈÄâ‰ª•ÂÖºÂÆπRemixÁ±ªÂûã
  originalSrc?: string;
}

interface PhotoGallery {
  id: string;
  name: string;
  photos: ImageData[];
}

interface PhotoPageData {
  heroImage: ImageData;
  photoGalleries: PhotoGallery[];
  content: {
    heroTitle: string;
    authorName: string;
    bioSubtitle: string;
    bioDescription: string;
    footer: {
      title: string;
      description: string;
      linkText: string;
    };
  };
}

// Links function for resource optimization - Á¨¶Âêàrule.mdË¶ÅÊ±Ç
export const links: LinksFunction = () => [
  { rel: "preload", as: "style", href: "/app/tailwind.css" },
];

// Meta function for SEO - Á¨¶Âêàrule.mdË¶ÅÊ±Ç
export const meta: MetaFunction = () => [
  { title: "ÊëÑÂΩ±‰ΩúÂìÅ - Ê±™ÂÆ∂‰øäÁöÑÊëÑÂΩ±ÈõÜ" },
  { name: "description", content: "Áî®ÈïúÂ§¥ËÆ∞ÂΩïÁîüÊ¥ªÁöÑÁæéÂ•ΩÁû¨Èó¥ÔºåÂ±ïÁ§∫ÈùíÂ≤õ‰πãÂΩ±‰∏é‰∫∫ÁîüÈöèÊãç" },
  { name: "keywords", content: "ÊëÑÂΩ±,ÁÖßÁâá,ÈùíÂ≤õ,Ë°óÊãç,‰∫∫ÂÉè,È£éÊôØ,Ê±™ÂÆ∂‰øä" },
  { property: "og:title", content: "ÊëÑÂΩ±‰ΩúÂìÅ - Ê±™ÂÆ∂‰øäÁöÑÊëÑÂΩ±ÈõÜ" },
  { property: "og:description", content: "Áî®ÈïúÂ§¥ËÆ∞ÂΩïÁîüÊ¥ªÁöÑÁæéÂ•ΩÁû¨Èó¥" },
  { property: "og:type", content: "website" },
];

// Action function Â∑≤ËΩ¨ÁßªÂà∞‰∏ìÈó®ÁöÑËµÑÊ∫êË∑ØÁî± /api/image-token„ÄÇ
// ‰∏∫‰∫Ü‰øùÊåÅÂêëÂêéÂÖºÂÆπÔºåPhoto È°µÈù¢‰ªÖ‰ΩúÈÄèÊòé‰ª£ÁêÜÔºåÈÅøÂÖçÁª¥Êä§‰∏§‰ªΩ‰ª£Á†Å„ÄÇ
export async function action({ request }: ActionFunctionArgs) {
  if (request.method !== "POST") {
    return json({ success: false, error: "Method not allowed" }, { status: 405 });
  }

  // ÈÄè‰º†Âà∞ÁúüÊ≠£ÁöÑ API„ÄÇ
  return fetch("/api/image-token", {
    method: "POST",
    headers: request.headers,
    body: request.body,
  });
}

// Loader function - ËøîÂõûÂéüÂßãÂõæÁâáÊï∞ÊçÆÔºåËÆ©ÂÆ¢Êà∑Á´Ø‰ΩøÁî®hooksÂ§ÑÁêÜtoken
export async function loader() {

  // ÂÆö‰πâÂéüÂßãÂõæÁâáÊï∞ÊçÆ
  const rawPhotoGalleries = [
    {
      id: 'street',
      name: 'ÈöèÊãçÂç≥ÊôØ',
      photos: [
        { id: 1, src: 'camera/a.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 1' },
        { id: 2, src: 'camera/b.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 2' },
        { id: 3, src: 'camera/c.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 3' },
        { id: 4, src: 'camera/d.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 4' },
        { id: 5, src: 'camera/e.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 5' },
        { id: 6, src: 'camera/f.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 6' },
        { id: 7, src: 'camera/g.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 7' },
        { id: 8, src: 'camera/h.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 8' },
        { id: 9, src: 'camera/i.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 9' },
        { id: 10, src: 'camera/j.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 10' },
        { id: 11, src: 'camera/k.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 11' },
        { id: 12, src: 'camera/l.jpg', alt: 'Ë°óÊãçÊëÑÂΩ± 12' }
      ]
    },
    {
      id: 'portrait',
      name: 'ÂÖâÂΩ±ÁïôÁóï',
      photos: [
        { id: 13, src: 'camera/m.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 1' },
        { id: 14, src: 'camera/n.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 2' },
        { id: 15, src: 'camera/o.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 3' },
        { id: 16, src: 'camera/p.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 4' },
        { id: 17, src: 'camera/q.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 5' },
        { id: 18, src: 'camera/r.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 6' },
        { id: 19, src: 'camera/s.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 7' },
        { id: 20, src: 'camera/t.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 8' },
        { id: 21, src: 'camera/u.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 9' },
        { id: 22, src: 'camera/v.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 10' },
        { id: 23, src: 'camera/w.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 11' },
        { id: 24, src: 'camera/x.jpg', alt: '‰∫∫ÂÉèÊëÑÂΩ± 12' }
      ]
    },
    {
      id: 'landscape',
      name: 'ÈùôÁúãÊó∂ÂÖâ',
      photos: [
        { id: 25, src: 'camera/y.jpg', alt: 'È£éÊôØÊëÑÂΩ± 1' },
        { id: 26, src: 'camera/z.jpg', alt: 'È£éÊôØÊëÑÂΩ± 2' },
        { id: 27, src: 'camera/aa.jpg', alt: 'È£éÊôØÊëÑÂΩ± 3' },
        { id: 28, src: 'camera/bb.jpg', alt: 'È£éÊôØÊëÑÂΩ± 4' },
        { id: 29, src: 'camera/cc.jpg', alt: 'È£éÊôØÊëÑÂΩ± 5' },
        { id: 30, src: 'camera/dd.jpg', alt: 'È£éÊôØÊëÑÂΩ± 6' },
        { id: 31, src: 'camera/ee.jpg', alt: 'È£éÊôØÊëÑÂΩ± 7' },
        { id: 32, src: 'camera/ff.jpg', alt: 'È£éÊôØÊëÑÂΩ± 8' },
        { id: 33, src: 'camera/gg.jpg', alt: 'È£éÊôØÊëÑÂΩ± 9' },
        { id: 34, src: 'camera/hh.jpg', alt: 'È£éÊôØÊëÑÂΩ± 10' },
        { id: 35, src: 'camera/ii.jpg', alt: 'È£éÊôØÊëÑÂΩ± 11' },
        { id: 36, src: 'camera/jj.jpg', alt: 'È£éÊôØÊëÑÂΩ± 12' }
      ]
    }
  ];

    // ËøîÂõûÂéüÂßãÂõæÁâáÊï∞ÊçÆÔºåËÆ©ÂÆ¢Êà∑Á´Ø‰ΩøÁî®hooksÂ§ÑÁêÜtoken
  const data: PhotoPageData = {
    heroImage: {
      id: 'hero',
      src: 'camera/ss.jpg', // heroÂõæÁâá‰πü‰ΩøÁî®OSSË∑ØÂæÑ
      alt: '2023~2025ÔºåÈùíÂ≤õ‰πãÂΩ±'
    },
    photoGalleries: rawPhotoGalleries, // ÂéüÂßãÊï∞ÊçÆÔºåÂÆ¢Êà∑Á´ØÂ§ÑÁêÜtoken
    content: {
      heroTitle: "2023~2025ÔºåÈùíÂ≤õ‰πãÂΩ±",
      authorName: "Ê±™ÂÆ∂‰øä",
      bioSubtitle: "Ëá™Áïô",
      bioDescription: "ËøôÈáåÁöÑÁÖßÁâáÔºåÊòØÊàëÊØï‰∏ö‰πãÂêéÊù•Âà∞ÈùíÂ≤õÂ∑•‰ΩúÈó≤Êöá‰πã‰ΩôÊâÄÊãçÁöÑÁÖßÁâáÔºåÂÖ∂‰∏≠‰πüÊúâ‰∏Ä‰∫õÁÖßÁâáÊòØÂú®ÂÆ∂‰π°ÊãçÁöÑÔºåÂ∑•‰Ωú‰∫ÜÂá†‰∏™ÊúàÂèåÂçÅ‰∏ÄÔºå‰π∞‰∫ÜÂ∞èÁ±≥14ÔºåÊâãÊú∫ÊãçÁÖßÊïàÊûúÂæàÂ•ΩÊøÄÂèë‰∫ÜÊàëÂú®Êó•Â∏∏Áî®ÊâãÊú∫ËÆ∞ÂΩïÁöÑ‰π†ÊÉØÔºå‰πüÂú®ËøôÈáåÁïô‰∏ã‰∫ÜÂæàÂ§öÁöÑÁÖßÁâá„ÄÇÁî±‰∫éÂæÆ‰ø°ÊúãÂèãÂúà‰ºöÊää‰ªª‰Ωï‰ΩìÁßØ10M‰ª•‰∏äÂõæÁâáÂéãÁº©ÊàêÂá†ÁôæKÔºåÂØºËá¥ÁîªË¥®ÊïàÊûúÈùûÂ∏∏ÈöæÁúãÔºåÊâÄ‰ª•‰Ω†Âú®ËøôÈáåËÉΩÁúãËßÅ‰∏Ä‰∫õÊàë‰ªéÊú™ÂàÜ‰∫´ËøáÁöÑÁÖßÁâá„ÄÇ",
      footer: {
        title: "ÈïúÂ§¥‰πãÂ§ñ",
        description: "ÁÖßÁâáËÉåÂêéÔºåÊÄªÊúâ‰∫õËØùÊÉ≥ËØ¥„ÄÇÂÖ≥‰∫éÂÖâÂΩ±ÔºåÂÖ≥‰∫éÁû¨Èó¥ÔºåÂÖ≥‰∫éÈÇ£‰∫õË¢´ÈïúÂ§¥ÊçïÊçâÁöÑÊÄùËÄÉ‰∏éÊÑüÊÇü„ÄÇ",
        linkText: "Êé¢Á¥¢ÂÜÖÂøÉÁã¨ÁôΩ"
      }
    }
  };

  return json(data, {
    headers: {
      "Cache-Control": "public, max-age=3600, stale-while-revalidate=7200", // ÂéüÂßãÊï∞ÊçÆÂèØ‰ª•ÈïøÊó∂Èó¥ÁºìÂ≠ò
    },
  });
}



// ‰ºòÂåñÁöÑÂõæÁâáÁªÑ‰ª∂ - ‰ΩøÁî®hooksÂ§ÑÁêÜtoken
const OptimizedImage = ({ 
  src, 
  alt, 
  className, 
  loading = "lazy",
  imageId,
  ...props 
}: {
  src: string;
  alt: string;
  className?: string;
  loading?: "lazy" | "eager";
  imageId?: string | number;
  'data-photo-id'?: string | number;
}) => {
  const [imageLoaded, setImageLoaded] = useState(false);
  const [hasError, setHasError] = useState(false);
  const [currentSrc, setCurrentSrc] = useState(src);
  const { getImageWithToken, handleImageError } = useImageToken();

  // Â§ÑÁêÜtokenËé∑Âèñ - Âè™ÂØπÈùûÊú¨Âú∞ÂõæÁâáÂ§ÑÁêÜ
  useEffect(() => {
    if (src && !src.startsWith('/') && !src.includes('token=')) {
      console.log('üîÑ ÂºÄÂßãËé∑ÂèñÂõæÁâátoken:', src);
      getImageWithToken(src)
        .then((tokenUrl) => {
          console.log('‚úÖ Ëé∑ÂèñtokenÊàêÂäü:', src, '->', tokenUrl);
          setCurrentSrc(tokenUrl);
        })
        .catch((error) => {
          console.error('‚ùå Ëé∑ÂèñtokenÂ§±Ë¥•:', src, error);
          setCurrentSrc(src);
        });
    }
  }, [src, getImageWithToken]);

  const placeholderSrc = "data:image/svg+xml,%3csvg width='400' height='300' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='%23f3f4f6'/%3e%3ctext x='50%25' y='50%25' font-family='system-ui,sans-serif' font-size='16' fill='%23a3a3a3' text-anchor='middle' dy='.3em'%3eÂä†ËΩΩ‰∏≠...%3c/text%3e%3c/svg%3e";

  return (
    <img
      src={hasError ? placeholderSrc : currentSrc}
      alt={alt}
      className={`transition-opacity duration-300 ${
        imageLoaded && !hasError ? 'opacity-100' : 'opacity-0'
      } ${className || ''}`}
      loading={loading}
      onLoad={() => setImageLoaded(true)}
      onError={(e) => {
        setHasError(true);
        if (imageId) {
          handleImageError(e, imageId);
        }
      }}
      suppressHydrationWarning={true}
      {...props}
    />
  );
};

// ÂÆ¢Êà∑Á´Ø‰∏ìÁî®ÁîªÂªäÁªÑ‰ª∂
const ClientOnlyGallery = ({ photoGalleries }: { photoGalleries: PhotoGallery[] }) => {
  useEffect(() => {
    console.log('üì∏ Photo gallery client-side initialized with', photoGalleries.length, 'galleries');
  }, [photoGalleries.length]);

  return (
    <>
      {photoGalleries.map((gallery, galleryIndex) => (
        <m.div
          key={gallery.id}
          className={`gallery-section py-16 px-3 text-center ${
            gallery.id === 'portrait' ? 'bg-gray-50' : ''
          }`}
          initial={{ opacity: 0 }}
          whileInView={{ opacity: 1 }}
          viewport={{ once: true, margin: "-100px" }}
          transition={{ duration: 0.6, delay: galleryIndex * 0.1 }}
        >
          <m.h2 
            className="text-4xl md:text-5xl font-bold mb-16 text-gray-700 uppercase tracking-wide"
            initial={{ opacity: 0, y: 30 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.6, delay: 0.2 }}
          >
            {gallery.name}
          </m.h2>
          
          <div className="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3 max-w-7xl mx-auto">
            {gallery.photos.map((photo, index) => (
              <m.div
                key={photo.id}
                className="grid-item w-full overflow-hidden bg-gray-200 aspect-square"
                initial={{ opacity: 0, y: 20 }}
                whileInView={{ opacity: 1, y: 0 }}
                viewport={{ once: true, margin: "-50px" }}
                transition={{ 
                  duration: 0.6, 
                  delay: index * 0.05,
                  ease: "easeOut"
                }}
                whileHover={{ scale: 1.02 }}
                whileTap={{ scale: 0.98 }}
              >
                <OptimizedImage
                  src={photo.src}
                  alt={photo.alt || `ÁÖßÁâá ${photo.id}`}
                  className="w-full h-full object-cover transition-all duration-300 hover:scale-105"
                  loading="lazy"
                  imageId={photo.id}
                  data-photo-id={photo.id}
                />
              </m.div>
            ))}
          </div>
        </m.div>
      ))}
    </>
  );
};

// Main photo page component
function PhotoPage() {
  const { heroImage, photoGalleries, content } = useLoaderData<typeof loader>();

  return (
    <LazyMotion features={domAnimation}>
      {/* Hero Image at the very top, with token logic */}
      <ClientOnly>
        {() => (
          <div className="w-full my-0 relative">
            <OptimizedImage
              src={heroImage.src}
              alt={heroImage.alt || "Hero Image"}
              className="w-full h-96 object-cover object-center rounded-lg shadow-md"
              loading="eager"
              imageId={heroImage.id}
            />
            {/* Âè†Âä†Â§ßÂ≠óÊ†áÈ¢ò */}
            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
              <span className="text-white text-4xl md:text-6xl font-extrabold drop-shadow-lg select-none">
                2023-2035ÔºåÈùíÂ≤õ‰πãÂΩ±
              </span>
            </div>
          </div>
        )}
      </ClientOnly>
      {/* Content Section */}
      <m.div 
        className="content-area max-w-4xl mx-auto my-16 px-5"
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.3, duration: 0.6 }}
      >
        <h2 className="text-4xl font-bold mb-6 text-gray-700">
          {content.authorName}
        </h2>
        <div className="bio-section">
          <h3 className="text-sm font-bold uppercase text-gray-600 mb-2 tracking-wider">
            {content.bioSubtitle}
          </h3>
          <p className="text-lg text-gray-600 leading-8 text-justify">
            {content.bioDescription}
          </p>
        </div>
      </m.div>

              {/* Dynamic Gallery Sections - Client Only */}
        <ClientOnly>
          {() => <ClientOnlyGallery photoGalleries={photoGalleries} />}
        </ClientOnly>

      {/* Footer Section */}
      <m.div 
        className="footer-section bg-gradient-to-br from-gray-50 to-gray-100 py-20 px-5 text-center mt-16"
        initial={{ opacity: 0 }}
        whileInView={{ opacity: 1 }}
        viewport={{ once: true }}
        transition={{ duration: 0.8 }}
      >
        <div className="footer-content max-w-2xl mx-auto">
          <m.div 
            className="w-16 h-1 bg-gradient-to-r from-gray-700 to-gray-500 mx-auto mb-8 rounded"
            initial={{ width: 0 }}
            whileInView={{ width: 64 }}
            viewport={{ once: true }}
            transition={{ duration: 0.8, delay: 0.2 }}
          />
          
          <m.h3 
            className="text-3xl font-bold text-gray-700 mb-5 tracking-wide"
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.6, delay: 0.3 }}
          >
            {content.footer.title}
          </m.h3>
          
          <m.p 
            className="text-lg text-gray-600 leading-8 mb-10 italic"
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.6, delay: 0.4 }}
          >
            {content.footer.description}
          </m.p>
          
          <m.div
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.6, delay: 0.5 }}
          >
            <Link
              to="/xiao"
              prefetch="intent"
              className="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-gray-700 to-gray-600 text-white font-medium rounded-full transition-all duration-300 hover:shadow-lg hover:-translate-y-1 hover:from-gray-600 hover:to-gray-500 relative overflow-hidden group"
            >
              <span className="relative z-10">{content.footer.linkText}</span>
              <svg 
                className="w-5 h-5 transition-transform duration-300 group-hover:translate-x-1 group-hover:-translate-y-1 relative z-10" 
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
              >
                <path 
                  strokeLinecap="round" 
                  strokeLinejoin="round" 
                  strokeWidth="2" 
                  d="M7 17L17 7M17 7H7M17 7V17" 
                />
              </svg>
              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-0 group-hover:opacity-20 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
            </Link>
          </m.div>
        </div>
      </m.div>

      {/* Back to home link */}
      <m.div 
        className="text-center py-8"
        initial={{ opacity: 0 }}
        whileInView={{ opacity: 1 }}
        viewport={{ once: true }}
        transition={{ duration: 0.6 }}
      >
        <Link
          to="/"
          prefetch="intent"
          className="text-gray-600 hover:text-gray-800 underline transition-colors duration-200"
        >
          ‚Üê ËøîÂõûÈ¶ñÈ°µ
        </Link>
      </m.div>
    </LazyMotion>
  );
}

export default PhotoPage;

// Error Boundary - Á¨¶Âêàrule.mdË¶ÅÊ±Ç
export function ErrorBoundary() {
  return (
    <div className="min-h-screen bg-red-50 flex items-center justify-center">
      <div className="bg-white p-8 rounded-lg shadow-lg max-w-md w-full mx-4">
        <div className="text-center">
          <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
          </div>
          <h1 className="text-xl font-semibold text-gray-900 mb-2">ÁÖßÁâáÈ°µÈù¢ÈîôËØØ</h1>
          <p className="text-gray-600 mb-4">Êä±Ê≠âÔºåÊëÑÂΩ±‰ΩúÂìÅÈ°µÈù¢ÊöÇÊó∂Êó†Ê≥ïÊòæÁ§∫„ÄÇ</p>
          <Link
            to="/"
            className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors inline-block"
          >
            ËøîÂõûÈ¶ñÈ°µ
          </Link>
        </div>
      </div>
    </div>
  );
} 
